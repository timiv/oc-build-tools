# =============================================================================
# Cross-compilation build system for hard-float (VFP) Python environment
# Target: Centauri Carbon (Allwinner, ARM Cortex-A7, VFPv4+NEON, glibc 2.23)
#
# Builds GCC 14 from source as a cross-compiler, configured against the
# vendor toolchain's sysroot (glibc 2.23).  This gives us:
#   - Full C++17 support
#   - libgcc / libstdc++ built against glibc 2.23
#   - No _Float16 on ARM32 → no __aeabi_d2h shim needed
# Source tarballs are downloaded automatically into dl/.
#
# Build logic is split into per-package files under pkg/.
# This file holds configuration, includes, and top-level targets.
#
# Prerequisites (Ubuntu/Debian):
#   sudo apt install binutils-arm-linux-gnueabihf \
#       build-essential curl pkg-config texinfo
#
# Usage:
#   make                    Build everything, produce archive
#   make download           Download all source tarballs
#   make python-host        Build host Python from source
#   make python-target      Cross-compile Python for target
#   make crossenv           Set up crossenv
#   make packages-kalico    Cross-compile kalico pip packages
#   make packages-moonraker Cross-compile moonraker pip packages
#   make zip                Package everything into archive
#   make verify             Verify hard-float ABI + glibc compat
#   make clean              Remove build artifacts (keeps downloads)
#   make distclean          Remove everything including downloads
# =============================================================================

SHELL := /bin/bash
JOBS  ?= 8

CURL ?= curl
TAR  ?= tar

# -- Source versions (single place to bump) -----------------------------------
PYTHON_VERSION            := 3.13.11
LIBFFI_VERSION            := 3.4.7
ZLIB_VERSION              := 1.3.1
GCC_NATIVE_VERSION        := 6.5.0
GCC_CROSS_VERSION         := 14.2.0
BINUTILS_VERSION          := 2.27
OPENSSL_VERSION           := 3.0.15
SQLITE_VERSION            := 3470200
LIBSODIUM_VERSION         := 1.0.20

# -- Derived versions and variables ------------------------------------------------------
PYTHON_MM := $(word 1,$(subst ., ,$(PYTHON_VERSION))).$(word 2,$(subst ., ,$(PYTHON_VERSION)))

# -- Vendor toolchain (OpenWrt SDK: Linaro GCC 6.4-2017.11, glibc 2.23) ------
VENDOR_TOOLCHAIN_VERSION  := sunxi-glibc-2.23
VENDOR_TOOLCHAIN_ARCHIVE  := openwrt-toolchain-$(VENDOR_TOOLCHAIN_VERSION).tar.gz

# -- Release version ----------------------------------------------------------
VERSION ?= 1.0.0

# -- Directory layout ---------------------------------------------------------
HERE        := $(abspath .)
DL_DIR      := $(HERE)/dl
VENDOR_DIR  := $(HERE)/vendor
SRC_DIR     := $(HERE)/src
BUILD_DIR   := $(HERE)/build
OUTPUT_DIR  := $(HERE)/output

STAMP := $(BUILD_DIR)/.stamps

# -- External paths -----------------------------------------------------------
VENDOR_SYSROOT := $(BUILD_DIR)/vendor-toolchain/toolchain
REQS_KALICO    := $(HERE)/requirements-kalico.txt
REQS_MOONRAKER := $(HERE)/requirements-moonraker.txt

# -- Install prefixes ---------------------------------------------------------
HOST_PREFIX       := $(BUILD_DIR)/staging/python-host
TARGET_PREFIX     := $(BUILD_DIR)/staging/python-target
CROSSENV_DIR      := $(BUILD_DIR)/staging/crossenv
NATIVE_GCC_PREFIX := $(BUILD_DIR)/staging/gcc-native
CROSS_GCC_PREFIX  := $(BUILD_DIR)/staging/gcc-cross

# -- Cross-compiler configuration --------------------------------------------
BUILD_TRIPLET := $(shell gcc -dumpmachine 2>/dev/null || echo x86_64-linux-gnu)

CROSS_HOST    := arm-linux-gnueabihf
CROSS_AR      := arm-linux-gnueabihf-ar
CROSS_RANLIB  := arm-linux-gnueabihf-ranlib
CROSS_STRIP   := arm-linux-gnueabihf-strip
CROSS_OBJDUMP := arm-linux-gnueabihf-objdump

ARCH_FLAGS := -march=armv7-a -mfpu=vfpv4 -mfloat-abi=hard

# Wrapper scripts (generated by pkg/cross-gcc.mk)
CROSS_CC  := $(BUILD_DIR)/.bin/arm-linux-gnueabihf-gcc
CROSS_CXX := $(BUILD_DIR)/.bin/arm-linux-gnueabihf-g++

CROSS_CFLAGS   := -O2 -fPIC
CROSS_CXXFLAGS := -O2 -fPIC
CROSS_LDFLAGS  := -L$(VENDOR_SYSROOT)/lib \
                  -Wl,-rpath-link,$(VENDOR_SYSROOT)/lib

VENDOR_GCC_RT := $(VENDOR_SYSROOT)/lib/gcc/arm-openwrt-linux-gnueabi/6.4.1
CROSS_GCC_RT  := $(CROSS_GCC_PREFIX)/lib/gcc/arm-linux-gnueabihf/$(GCC_CROSS_VERSION)

ZIP_NAME := open-centauri-$(VERSION)-armhf.tar.gz

# -- Phony targets (must be before includes to ensure 'all' is the default) -----
.PHONY: all download zip verify clean distclean help

all: zip verify

# -- Load macros and per-package build files ----------------------------------
include pkg/pkg-macros.mk
include $(sort $(wildcard pkg/*/*.mk))

help:
	@echo "Common targets:"
	@echo "  all        — Build everything and create archive (default)"
	@echo "  download   — Download all source tarballs"
	@echo "  zip        — Package deployable archive"
	@echo "  verify     — Verify hard-float ABI + glibc compatibility"
	@echo "  clean      — Remove build artifacts (keeps downloads)"
	@echo "  distclean  — Remove everything including downloads"
	@echo ""
	@echo "Package targets:"
	@$(foreach target,$(ALL_TARGETS),echo "  $(target)$(shell printf '%*s' $$((20-$$(echo -n '$(target)' | wc -c))) '') — $(HELP_$(target))";)

download: $(ALL_DOWNLOADS)

# -- Build directory ----------------------------------------------------------
$(BUILD_DIR):
	@mkdir -p $@

# -- Archive ------------------------------------------------------------------
zip: $(STAMP)/zip

$(STAMP)/zip: $(STAMP)/packages-kalico $(STAMP)/packages-moonraker $(STAMP)/gcc-native
	@echo "==> Packaging deployable archive..."
	@mkdir -p $(OUTPUT_DIR)
	bash $(HERE)/pack-env.sh \
		--target-prefix $(TARGET_PREFIX) --crossenv $(CROSSENV_DIR) \
		--python-version $(PYTHON_MM) \
		--sysroot-lib $(VENDOR_SYSROOT)/lib \
		--cross-gcc-lib $(CROSS_GCC_PREFIX)/arm-linux-gnueabihf/lib \
		--gcc-prefix $(NATIVE_GCC_PREFIX)/opt/open-centauri \
		--output $(OUTPUT_DIR)/$(ZIP_NAME)
	@echo "==> Archive: $(OUTPUT_DIR)/$(ZIP_NAME)"
	@touch $@

# -- Verification -------------------------------------------------------------
verify: $(STAMP)/zip
	@bash $(HERE)/verify.sh $(TARGET_PREFIX) $(CROSSENV_DIR)/cross $(NATIVE_GCC_PREFIX)/opt/open-centauri

# -- Cleanup ------------------------------------------------------------------
clean:
	rm -rf $(BUILD_DIR) $(SRC_DIR) $(OUTPUT_DIR)

distclean: clean
	rm -rf $(DL_DIR)
